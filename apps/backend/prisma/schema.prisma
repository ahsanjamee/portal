// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
    provider        = "prisma-client-js"
    previewFeatures = []
}

datasource db {
    provider = "mongodb"
    url      = env("DATABASE_URL")
}

// Enums for user types
enum AuthType {
    END_USER
    ADMIN
    SUPER_ADMIN
}

enum EndUserType {
    DAIRY_FARMER
    POULTRY_FARMER
    FISH_FARMER
    AGRICULTURE_FARMER
}

enum AdminUserType {
    SERVICE_PROVIDER
    TRADER_CHEMIST
}

enum PoultryFarmType {
    LAYER
    BROILER
}

// Base User model
model User {
    id          String   @id @default(auto()) @map("_id") @db.ObjectId
    authType    AuthType
    mobileNumber String? @unique
    email       String?  @unique
    password    String?  // Only for super admin
    isVerified  Boolean?  @default(false)
    isActive    Boolean  @default(true)
    createdAt   DateTime @default(now())
    updatedAt   DateTime @updatedAt
    
    // Relations
    endUserProfile   EndUserProfile?
    adminUserProfile AdminUserProfile?
    
    // OTP related
    otps        OTP[]
    
    // JWT refresh tokens
    refreshTokens RefreshToken[]
    
    @@map("users")
}

model VerifiedMobileNumber {
    id String @id @default(auto()) @map("_id") @db.ObjectId
    mobileNumber String @unique
    isVerified Boolean @default(false)
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
}

// OTP Tracking model for tracking sent OTP messages
model OtpTracking {
    id              String   @id @default(auto()) @map("_id") @db.ObjectId
    companyName     String   @default("ADI")
    recipientNumber String
    message         String
    messageType     String   @default("OTP")
    status          String   // SUCCESS, FAILED, PENDING
    provider        String   @default("MIMSMS")
    cost            Float?   // Cost per SMS if available
    errorMessage    String?  // Error details if failed
    createdAt       DateTime @default(now())
    updatedAt       DateTime @updatedAt
    
    @@map("otp_tracking")
}

// Refresh Token model for JWT authentication
model RefreshToken {
    id        String   @id @default(auto()) @map("_id") @db.ObjectId
    userId    String   @db.ObjectId
    token     String   @unique
    expiresAt DateTime
    isValid   Boolean  @default(true)
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
    
    user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
    
    @@map("refresh_tokens")
}

// Optional: Token Blacklist for immediate access token revocation
// Uncomment if you need immediate token revocation
// model TokenBlacklist {
//     id        String   @id @default(auto()) @map("_id") @db.ObjectId
//     token     String   @unique // JWT ID (jti) or full token hash
//     userId    String   @db.ObjectId
//     expiresAt DateTime
//     reason    String?  // "logout", "security_breach", etc.
//     createdAt DateTime @default(now())
//     
//     user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
//     
//     @@map("token_blacklist")
// }

// OTP model for authentication
model OTP {
    id        String   @id @default(auto()) @map("_id") @db.ObjectId
    userId    String   @db.ObjectId
    code      String
    expiresAt DateTime
    isUsed    Boolean  @default(false)
    createdAt DateTime @default(now())
    
    user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
    
    @@map("otps")
}

// End User Profile (Normal Users)
model EndUserProfile {
    id          String      @id @default(auto()) @map("_id") @db.ObjectId
    userId      String      @unique @db.ObjectId
    userType    EndUserType
    
    // Personal Information (common for all end users)
    name        String
    address     String
    photo       String?
    
    // Farm specific data (stored as flexible JSON)
    farmData    Json
    
    user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
    
    // Relations
    prescriptions Prescription[]
    
    @@map("end_user_profiles")
}

// Admin User Profile
model AdminUserProfile {
    id          String        @id @default(auto()) @map("_id") @db.ObjectId
    userId      String        @unique @db.ObjectId
    userType    AdminUserType
    
    // Personal Information
    name        String
    address     String
    photo       String?
    
    // Educational Qualification
    lastDegree  String
    areaOfExpertise String
    serviceExperience Int // in years
    jobPosition String?     // Only for service provider
    
    user        User          @relation(fields: [userId], references: [id], onDelete: Cascade)
    
    // Relations
    prescriptions Prescription[]
    
    @@map("admin_user_profiles")
}

// Prescription model for livestock care
model Prescription {
    id          String   @id @default(auto()) @map("_id") @db.ObjectId
    reference   String   // Patient reference number
    
    // Doctor Information
    doctorId    String   @db.ObjectId
    doctor      AdminUserProfile @relation(fields: [doctorId], references: [id], onDelete: Cascade)
    
    // Patient Information
    patientId   String   @db.ObjectId
    patient     EndUserProfile @relation(fields: [patientId], references: [id], onDelete: Cascade)
    
    // Animal Information
    animalType  String   // Calf, Cow, etc.
    animalPicture String?
    patientNumber Int    @default(0)
    age         String?
    sex         String?  // M/F
    weight      Float?   // in kg
    
    // Vital Signs
    temperature String?  // Normal, fever, etc.
    spo2        String?  // Oxygen saturation
    respirationRate String? // Normal, fast, slow
    fecesStatus String?  // Normal, diarrhea, etc.
    nasalSecretion String? // Normal, runny, etc.
    feedingHistory String? // Grass, straw, mixed feed
    
    // Medical History
    medicationHistory String? // Previous medications
    investigation String?    // Any investigations done
    
    // Prescription Details
    medications Json     // Array of medications with dosage and instructions
    advice      String?  // Doctor's advice
    
    // Consultation Details
    consultancyFee Float?
    followUpDate DateTime?
    
    createdAt   DateTime @default(now())
    updatedAt   DateTime @updatedAt
    
    @@map("prescriptions")
}


